# PostgreSQL 数据库巡检报告

**生成时间**: 2025-12-17 11:44:57  
**数据库角色**: Primary 主库

---

## 目录

1. [系统信息](#系统信息)
2. [数据库版本信息](#数据库版本信息)
3. [已安装扩展](#已安装扩展)
4. [数据库配置](#数据库配置)
5. [连接状态](#连接状态)
6. [性能统计](#性能统计)
7. [慢查询分析](#慢查询分析)
8. [等待事件分析](#等待事件分析)
9. [空间使用](#空间使用)
10. [表和索引分析](#表和索引分析)
11. [垃圾回收状态](#垃圾回收状态)
12. [复制状态](#复制状态)
13. [锁等待](#锁等待)
14. [长事务检查](#长事务检查)
15. [建议汇总](#建议汇总)

---

## 系统信息

### 主机名
```
pg9
```

### 操作系统
```
Linux pg9 5.14.0-611.5.1.el9_7.x86_64 #1 SMP PREEMPT_DYNAMIC Tue Nov 11 22:20:27 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
```

### CPU 信息
```
Architecture:                            x86_64
CPU(s):                                  2
Model name:                              13th Gen Intel(R) Core(TM) i5-13600KF
```

### 内存信息
```
               total        used        free      shared  buff/cache   available
Mem:           3.6Gi       635Mi       1.0Gi       326Mi       2.3Gi       2.9Gi
Swap:             0B          0B          0B
```

### 磁盘使用
```
Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/rlm-root   64G  3.8G   60G   6% /
/dev/sda2             960M  247M  714M  26% /boot
/dev/mapper/rlm-home   31G  254M   31G   1% /home
/dev/sda1             599M  7.1M  592M   2% /boot/efi
```

---

## 数据库版本信息

### PostgreSQL 版本
```sql
                                                  version                                                  
-----------------------------------------------------------------------------------------------------------
 PostgreSQL 17.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 11.5.0 20240719 (Red Hat 11.5.0-11), 64-bit
(1 row)
```

### 数据库启动时间
```sql
           启动时间            |    运行时长     
-------------------------------+-----------------
 2025-12-17 10:17:40.084576+08 | 01:27:17.904118
(1 row)
```

---

## 已安装扩展

### 所有数据库的扩展列表
```sql
-- 数据库: postgres
       扩展名       | 版本  |    模式    
--------------------+-------+------------
 pg_cron            | 1.6   | pg_catalog
 pg_partman         | 5.3.1 | public
 pg_prewarm         | 1.2   | public
 pg_qualstats       | 2.1.3 | public
 pg_repack          | 1.5.3 | public
 pg_stat_kcache     | 2.3.1 | public
 pg_stat_monitor    | 2.3   | public
 pg_stat_statements | 1.11  | public
 pg_wait_sampling   | 1.1   | public
 plpgsql            | 1.0   | pg_catalog
 plpython3u         | 1.0   | pg_catalog
 postgis            | 3.6.1 | public
 postgis_raster     | 3.6.1 | public
 postgis_topology   | 3.6.1 | topology
(14 rows)

```

**建议**: 
- 确保关键性能监控扩展已启用: `pg_stat_statements`, `pg_stat_kcache`, `pg_wait_sampling`
- PostGIS 相关应用应确保 `postgis`, `postgis_topology`, `postgis_raster` 已安装

---

## 数据库配置

### 关键配置参数
```sql
           参数名           |                                         当前值                                          | 单位 |        来源        
----------------------------+-----------------------------------------------------------------------------------------+------+--------------------
 autovacuum                 | on                                                                                      |      | configuration file
 autovacuum_max_workers     | 5                                                                                       |      | configuration file
 checkpoint_timeout         | 300                                                                                     | s    | default
 effective_cache_size       | 393216                                                                                  | 8kB  | configuration file
 effective_io_concurrency   | 1                                                                                       |      | default
 log_min_duration_statement | -1                                                                                      | ms   | default
 maintenance_work_mem       | 131072                                                                                  | kB   | configuration file
 max_connections            | 100                                                                                     |      | configuration file
 max_parallel_workers       | 8                                                                                       |      | default
 max_wal_size               | 1024                                                                                    | MB   | configuration file
 max_worker_processes       | 8                                                                                       |      | default
 min_wal_size               | 80                                                                                      | MB   | configuration file
 random_page_cost           | 1.1                                                                                     |      | configuration file
 shared_buffers             | 131072                                                                                  | 8kB  | configuration file
 shared_preload_libraries   | pg_stat_statements,pg_stat_kcache,pg_wait_sampling,pg_qualstats,pg_stat_monitor,pg_cron |      | configuration file
 wal_buffers                | 2048                                                                                    | 8kB  | configuration file
 work_mem                   | 16384                                                                                   | kB   | configuration file
(17 rows)
```

### 用户/数据库级别定制参数
```sql
 角色 |  数据库  |                 配置                  
------+----------+---------------------------------------
 ALL  | postgres | search_path="$user", public, topology
(1 row)
```

**建议**: 
- 定制参数优先级高于配置文件,排查问题时需特别关注
- 建议根据工作负载调整 `work_mem` 和 `shared_buffers`

---

## 连接状态

### 当前连接统计
```sql
  状态  | 连接数 
--------+--------
        |      7
 active |      1
(2 rows)
```

### 各数据库连接数
```sql
  数据库  | 当前连接数 | 最大连接数 
----------+------------+------------
          |          6 |        100
 postgres |          2 |        100
(2 rows)
```

### 各用户连接数
```sql
   用户   | 连接数 | 连接限制 
----------+--------+----------
          |      4 |         
 postgres |      4 |       -1
(2 rows)
```

**建议**: 
- `idle in transaction` 状态过多说明应用层事务管理有问题
- 连接数接近 `max_connections` 时考虑使用连接池 (如 pgbouncer)

---

## 性能统计

### pg_stat_statements - TOP 10 慢查询 (按总耗时)
```sql
                                 查询语句(截断)                                 | 调用次数 | 总耗时(ms) | 平均耗时(ms) | 最大耗时(ms) | 标准差(ms) 
--------------------------------------------------------------------------------+----------+------------+--------------+--------------+------------
 SELECT name AS 参数名,                                                        +|        3 |       2.42 |         0.81 |         0.85 |       0.03
        setting AS 当前值,                                                     +|          |            |              |              | 
        unit AS 单位,                                                          +|          |            |              |              | 
        source AS                                                               |          |            |              |              | 
 SELECT datname AS 数据库,                                                     +|        3 |       2.41 |         0.80 |         0.88 |       0.05
        COUNT(*) AS 当前连接数,                                                +|          |            |              |              | 
        (SELECT setting::int FRO                                                |          |            |              |              | 
 SELECT                                                                        +|        2 |       1.43 |         0.72 |         0.73 |       0.01
     name AS 参数名,                                                           +|          |            |              |              | 
     setting AS 值,                                                            +|          |            |              |              | 
     unit AS 单位                                                              +|          |            |              |              | 
 FROM pg_settings                                                              +|          |            |              |              | 
 WHERE                                                                          |          |            |              |              | 
 SELECT                                                                        +|        2 |       1.30 |         0.65 |         0.66 |       0.00
     spcname AS 表空间名,                                                      +|          |            |              |              | 
     pg_tablespace_location(oid) AS 位置,                                      +|          |            |              |              | 
     pg_size_                                                                   |          |            |              |              | 
 SELECT                                                                        +|        1 |       1.28 |         1.28 |         1.28 |       0.00
     schemaname AS "模式",                                                     +|          |            |              |              | 
     tablename AS "表名",                                                      +|          |            |              |              | 
     pg_size_pretty(pg_tot                                                      |          |            |              |              | 
 SELECT                                                                        +|        2 |       1.24 |         0.62 |         0.65 |       0.03
     datname AS 数据库名,                                                      +|          |            |              |              | 
     pg_size_pretty(pg_database_size(datname)) AS 大小                          |          |            |              |              | 
 SELECT                                                                        +|        1 |       0.60 |         0.60 |         0.60 |       0.00
     bucket AS "时间桶",                                                       +|          |            |              |              | 
     substring(query, $1, $2) AS "查询(截断)",                                 +|          |            |              |              | 
     calls                                                                      |          |            |              |              | 
 SELECT datname FROM pg_database WHERE datname NOT IN ($1, $2) ORDER BY datname |       13 |       0.45 |         0.03 |         0.06 |       0.01
 SELECT                                                                        +|        2 |       0.34 |         0.17 |         0.17 |       0.00
     event_type AS 等待类型,                                                   +|          |            |              |              | 
     event AS 等待事件,                                                        +|          |            |              |              | 
     COUNT(*) AS 等待次数                                                      +|          |            |              |              | 
 FROM pg_                                                                       |          |            |              |              | 
 SELECT usename AS 用户,                                                       +|        3 |       0.34 |         0.11 |         0.13 |       0.01
        COUNT(*) AS 连接数,                                                    +|          |            |              |              | 
        r.rolconnlimit AS 连接限制                                             +|          |            |              |              | 
 FROM                                                                           |          |            |              |              | 
(10 rows)
```

### pg_stat_statements - TOP 10 高频查询
```sql
                                 查询语句(截断)                                 | 调用次数 | 平均耗时(ms) | 总耗时(ms) 
--------------------------------------------------------------------------------+----------+--------------+------------
 SELECT                                                                         |       32 |         0.00 |       0.12
 SELECT COUNT(*) FROM pg_extension WHERE extname=$1                             |       17 |         0.02 |       0.35
 SELECT datname FROM pg_database WHERE datname NOT IN ($1, $2) ORDER BY datname |       13 |         0.03 |       0.45
 SELECT $1                                                                      |        8 |         0.01 |       0.04
 SELECT pg_is_in_recovery()                                                     |        4 |         0.01 |       0.02
 SELECT state AS 状态,                                                         +|        3 |         0.06 |       0.17
        COUNT(*) AS 连接数                                                     +|          |              | 
 FROM pg_stat_activity                                                         +|          |              | 
 GROUP BY state                                                                +|          |              | 
                                                                                |          |              | 
 SELECT usename AS 用户,                                                       +|        3 |         0.11 |       0.34
        COUNT(*) AS 连接数,                                                    +|          |              | 
        r.rolconnlimit AS 连接限制                                             +|          |              | 
 FROM                                                                           |          |              | 
 SELECT pg_postmaster_start_time() AS 启动时间,                                +|        3 |         0.02 |       0.07
        NOW() - pg_postmaster_start_t                                           |          |              | 
 SELECT version()                                                               |        3 |         0.01 |       0.02
 SELECT name AS 参数名,                                                        +|        3 |         0.81 |       2.42
        setting AS 当前值,                                                     +|          |              | 
        unit AS 单位,                                                          +|          |              | 
        source AS                                                               |          |              | 
(10 rows)
```

### pg_stat_kcache - 系统资源消耗 TOP 10
```sql
psql:/tmp/tmp.WQQOA8mwNv:9: ERROR:  column k.queryid does not exist
LINE 7: JOIN pg_stat_statements s ON k.queryid = s.queryid AND k.use...
                                     ^
HINT:  Perhaps you meant to reference the column "s.queryid".
```

### pg_stat_monitor - 查询性能监控摘要
```sql
 时间桶 |                          查询(截断)                          | 次数 | 平均耗时(ms) | 标准差(ms) 
--------+--------------------------------------------------------------+------+--------------+------------
      4 | SELECT name AS "参数名",                                    +|    1 |         0.80 |       0.00
        |        setting AS "当前值",                                 +|      |              | 
        |        unit                                                  |      |              | 
      4 | SELECT datname AS "数据库",                                 +|    1 |         0.76 |       0.00
        |        COUNT(*) AS "当前连接数",                            +|      |              | 
        |                                                              |      |              | 
      4 | SELECT                                                      +|    1 |         0.32 |       0.00
        |     substring(query, 1, 80) AS "查询语句(截断)",            +|      |              | 
        |     calls                                                    |      |              | 
      4 | SELECT                                                      +|    1 |         0.20 |       0.00
        |     substring(query, 1, 80) AS "查询语句(截断)",            +|      |              | 
        |     calls                                                    |      |              | 
      4 | SELECT usename AS "用户",                                   +|    1 |         0.11 |       0.00
        |        COUNT(*) AS "连接数",                                +|      |              | 
        |        r.r                                                   |      |              | 
      4 | SELECT extname AS "扩展名",                                 +|    1 |         0.05 |       0.00
        |            extversion AS "版本",                            +|      |              | 
        |                                                              |      |              | 
      4 | SELECT state AS "状态",                                     +|    1 |         0.05 |       0.00
        |        COUNT(*) AS "连接数"                                 +|      |              | 
        | FROM pg_stat_                                                |      |              | 
      4 | SELECT COALESCE(r.rolname, 'ALL') AS "角色",                +|    1 |         0.05 |       0.00
        |        COALESCE(d                                            |      |              | 
      4 | SELECT datname FROM pg_database WHERE datname NOT IN ('templ |    1 |         0.03 |       0.00
      4 | SELECT COUNT(*) FROM pg_extension WHERE extname='pg_stat_sta |    4 |         0.02 |       0.00
(10 rows)
```

**建议**: 
- 优化总耗时最高的查询,可显著提升整体性能
- 关注平均耗时和标准差,标准差大说明性能不稳定
- 使用 `EXPLAIN ANALYZE` 分析慢查询的执行计划

---

## 慢查询分析

### 当前正在执行的慢查询 (>5秒)
```sql
 进程ID | 用户 | 数据库 | 状态 | 执行时长 | 查询语句(截断) 
--------+------+--------+------+----------+----------------
(0 rows)
```

**建议**: 
- 执行时间过长的查询可能需要优化或添加索引
- 必要时可使用 `pg_cancel_backend(pid)` 取消查询

---

## 等待事件分析

### pg_wait_sampling - 等待事件统计
```sql
 等待类型  |       等待事件        | 等待次数 
-----------+-----------------------+----------
           |                       |      119
 Client    | ClientRead            |        6
 IO        | WalSync               |        4
 Timeout   | VacuumDelay           |        1
 Activity  | LogicalLauncherMain   |        1
 Activity  | AutovacuumMain        |        1
 IO        | DataFileWrite         |        1
 IO        | DataFileSync          |        1
 Activity  | CheckpointerMain      |        1
 Activity  | BgwriterMain          |        1
 IO        | DataFileFlush         |        1
 Activity  | BgwriterHibernate     |        1
 IO        | ControlFileSyncUpdate |        1
 Extension | Extension             |        1
 Timeout   | CheckpointWriteDelay  |        1
 Activity  | WalWriterMain         |        1
(16 rows)
```

**建议**: 
- `Lock` 类型等待过多说明存在锁竞争
- `IO` 类型等待过多说明磁盘性能是瓶颈
- `CPU` 类型等待说明计算密集

---

## 空间使用

### 表空间使用情况
```sql
  表空间名  | 位置 |  大小  
------------+------+--------
 pg_default |      | 32 MB
 pg_global  |      | 581 kB
(2 rows)
```

### 数据库大小
```sql
 数据库名  |  大小   
-----------+---------
 postgres  | 17 MB
 template1 | 7771 kB
 template0 | 7545 kB
(3 rows)
```

### TOP 10 最大的表
```sql
-- 数据库: postgres
   模式   |      表名       | 总大小  | 表大小  | 索引大小 
----------+-----------------+---------+---------+----------
 public   | spatial_ref_sys | 7144 kB | 6896 kB | 248 kB
 topology | layer           | 24 kB   | 0 bytes | 24 kB
 cron     | job             | 24 kB   | 0 bytes | 24 kB
 public   | part_config     | 24 kB   | 0 bytes | 24 kB
 topology | topology        | 24 kB   | 0 bytes | 24 kB
 cron     | job_run_details | 16 kB   | 0 bytes | 16 kB
 public   | part_config_sub | 16 kB   | 0 bytes | 16 kB
(7 rows)

```

**建议**: 
- 单表超过 10GB 且频繁更新的表考虑分区
- 定期清理历史数据,避免表过度膨胀

---

## 表和索引分析

### 未使用的索引 (扫描次数 < 10)
```sql
-- 数据库: postgres
 模式 | 表名 | 索引名 | 扫描次数 | 索引大小 
------+------+--------+----------+----------
(0 rows)

```

### 索引数量过多的表 (>4个索引)
```sql
-- 数据库: postgres
 模式 | 表名 | 索引数量 | 表总大小 
------+------+----------+----------
(0 rows)

```

**建议**: 
- 删除未使用的索引可提升写入性能
- 索引过多会降低 INSERT/UPDATE/DELETE 性能

---

## 垃圾回收状态

### Autovacuum 配置
```sql
                参数名                 |    值     | 单位 
---------------------------------------+-----------+------
 autovacuum                            | on        | 
 autovacuum_analyze_scale_factor       | 0.05      | 
 autovacuum_analyze_threshold          | 50        | 
 autovacuum_freeze_max_age             | 200000000 | 
 autovacuum_max_workers                | 5         | 
 autovacuum_multixact_freeze_max_age   | 400000000 | 
 autovacuum_naptime                    | 30        | s
 autovacuum_vacuum_cost_delay          | 10        | ms
 autovacuum_vacuum_cost_limit          | 2000      | 
 autovacuum_vacuum_insert_scale_factor | 0.2       | 
 autovacuum_vacuum_insert_threshold    | 1000      | 
 autovacuum_vacuum_scale_factor        | 0.02      | 
 autovacuum_vacuum_threshold           | 50        | 
 autovacuum_work_mem                   | -1        | kB
(14 rows)
```

### 垃圾数据最多的表 TOP 10
```sql
-- 数据库: postgres
  模式  |      表名       | 活跃行数 | 死亡行数 | 垃圾比例(%) |         最后自动清理          
--------+-----------------+----------+----------+-------------+-------------------------------
 public | spatial_ref_sys |     8500 |        0 |        0.00 | 2025-12-17 10:17:55.201539+08
(1 row)

```

### 表年龄检查 (XID 消耗)
```sql
-- 数据库: postgres
   模式   |      表名       | 年龄 |  剩余XID   
----------+-----------------+------+------------
 public   | spatial_ref_sys |   33 | 2147483615
 topology | layer           |   31 | 2147483617
 topology | topology        |   31 | 2147483617
 public   | part_config     |   26 | 2147483622
 public   | part_config_sub |   26 | 2147483622
 cron     | job_run_details |   25 | 2147483623
 cron     | job             |   25 | 2147483623
(7 rows)

```

**建议**: 
- 垃圾比例超过 20% 的表需要执行 VACUUM
- 表年龄超过 15 亿需要关注,接近 20 亿需要立即处理
- 确保 autovacuum 已开启且配置合理

---

## 复制状态

### 流复制状态
```sql
 备库地址 | 状态 | 同步状态 | 发送延迟(bytes) | 写入延迟(bytes) | 刷盘延迟(bytes) | 应用延迟(bytes) 
----------+------+----------+-----------------+-----------------+-----------------+-----------------
(0 rows)
```

### 复制槽状态
```sql
 槽名称 | 类型 | 数据库 | 活跃 | WAL延迟(bytes) 
--------+------+--------+------+----------------
(0 rows)
```

**建议**: 
- 复制延迟过大需检查网络带宽和磁盘 IO
- 不活跃的复制槽会导致 WAL 堆积,需及时清理

---

## 锁等待

### 当前锁等待
```sql
 被阻塞PID | 被阻塞用户 | 阻塞PID | 阻塞用户 | 被阻塞查询 | 阻塞查询 
-----------+------------+---------+----------+------------+----------
(0 rows)
```

**建议**: 
- 锁等待时间过长需要分析业务逻辑,优化事务粒度
- 必要时可使用 `pg_terminate_backend(pid)` 终止阻塞会话

---

## 长事务检查

### 运行超过 30 分钟的事务
```sql
 进程ID | 用户 | 数据库 | 状态 | 事务时长 | 查询时长 | 查询(截断) 
--------+------+--------+------+----------+----------+------------
(0 rows)
```

### 准备事务 (2PC)
```sql
 全局事务ID | 准备时间 | 所有者 | 数据库 
------------+----------+--------+--------
(0 rows)
```

**建议**: 
- 长事务会阻止垃圾回收,导致表膨胀
- 2PC 事务必须及时提交或回滚,否则会导致严重问题

---

## 建议汇总

### 性能优化建议

1. **慢查询优化**: 使用 `pg_stat_statements` 找出耗时最长的查询并优化
2. **索引优化**: 删除未使用的索引,为高频查询添加合适的索引
3. **连接池**: 如果连接数较高,建议使用 pgbouncer 等连接池
4. **配置调优**: 根据硬件资源调整 `shared_buffers`, `work_mem` 等参数

### 空间管理建议

1. **定期清理**: 对垃圾比例高的表执行 VACUUM
2. **分区策略**: 对大表考虑使用 `pg_partman` 进行分区管理
3. **归档策略**: 定期归档或删除历史数据

### 监控建议

1. **启用关键扩展**: 确保 `pg_stat_statements`, `pg_stat_kcache`, `pg_wait_sampling` 已启用
2. **定期巡检**: 建议每周运行本巡检脚本
3. **日志分析**: 定期分析 PostgreSQL 日志,关注错误和警告

### 高可用建议

1. **复制监控**: 密切监控流复制延迟
2. **备份策略**: 确保有完善的备份和恢复流程
3. **故障演练**: 定期进行故障切换演练

---

## 报告结束

**生成工具**: PostgreSQL 巡检报告生成脚本  
**脚本位置**: bin/generate_pg_report.sh  

---
